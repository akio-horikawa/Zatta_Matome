# PowerApps

Microsoft365から利用。SharePoint上にlistを作成して連携、Databaseのようにして利用する。見た目上はコンポーネントを置くのみ。コンポーネント内部に処理を書き込むなどして設定を行う。物によってはOnChange等の設定が行えないものも有る為、工夫が必要。画面遷移と画面間でのデータの受け渡し自体は容易。

## インポートとエクスポート

PowerAppsで作成したアプリは専用のパッケージとしてエクスポート可能。設定を変更しなければ「更新」用のパッケージがダウンロードできるはず。
「更新」用のパッケージはすでにマイアプリに存在するアプリに対して更新を行うものであり、アプリのバックアップ用のものである。
これと別に「新規作成」のパッケージがあり、これはマイアプリ内にインポートしたパッケージのアプリを新しく作成するものである。
どちらのパッケージでもインポート時には、他の機能（SharePointやAutomate）などとの接続を行うアカウントを設定する必要がある。

__とりあえず変更を行う前にバックアップとしてエクスポートすべき。__

PowerAppsは「公開」をしなければ更新者以外からは環境が変化しないが、更新者の環境では自動保存によってかなりの頻度で更新が保存されていく。

#### SharePoint連携

PowerApps内、左メニューからデータ（見た目：ドラム缶）を選択。パスの指定など設定をすることでApps上で利用できるようになる。Apps上ではSharePointのカラムは表示されている名前（外部列名）ではなく、内部列名が表示される。
関数やアイテムによっては内部列数でなければ認識されないこともあり、また、外部列数変更時でも内部列数は変化しないため、リストの管理時にも便利なので普段から指定する時は内部列数を利用すべき。
  また、カラム作成時にシングルバイトでない文字で作成すると内部列数は自動的にエンコードされた値になる。（大抵は`OData__x000a_`のような形）
  対処方法としては作成時はシングルバイトの列名を設定して作成し、その後に日本語などの列名に変更する事。

  内部列数の確認方法については、以下。
  1. SharePointリスト右上の歯車から設定を開く。
  2. 設定から「リストの設定」を開く。
  3. 列の一覧から確認したいカラムを選択。
  4. URLの Field= 以降が内部列数。

#### PowerAutomate連携

PowerApps内、左メニューからPowerAutomate（太い矢印（右向き））を選択。AutomateでAppsでの呼び出しをトリガーにしたフローが無ければ意味がない。
  また、Automateのフロー内でSharePoint等の接続状況だったり、参照するデータの向き先（SharePointなどの指定）を変更した場合にはApps側で設定しているAutomateの状態を更新をしてあげないと上手く動かなくなる。

### Collect / ClearCollect

`Collect(データソース, レコード, ...レコード)` `ClearCollect(データソース, レコード, ...レコード)` コード的には差はほとんどない。ClearCollectは一度データソース内をクリア（削除）してからレコードを追加する。Collectの方はクリアしないのでレコードは追加されるだけ。

### Filter

`Filter(テーブル, 条件, ...条件)` テーブル内から指定した条件に合うデータだけ抜き出す。Collectのレコード指定等で利用。

```
Collect(DateSource,
    Filter(Table,
        ID = SelectID,
        Name = DeployName,
        Date =< SelectDate
    )
)
```

### Distinct

`Distinct(テーブル, カラム, ...カラム)` テーブル内の指定したカラム内で重複するデータを削除する。カラムの指定が無ければ全カラムで重複削除を行う。

```
Collect(DataSource,
    Distinct(
        Filter(Table,
            Name = DeployName,
            Date =< SelectDate
        )
        ,
        ID
    )
)
```

### AddColumns

`AddColumns(テーブル, 列名1, 数式1, ...)` Collect関数などで設定したコレクションにカラムを追加する関数。

```
Collect(DataSource2,
    AddColumns(
        Datasource,
        testData,
        thisItem.testData
    )
)
```

### Patch

`Patch(テーブル, 基本のテーブル, レコード1, ...)` SharePointのリストなど、データソースの更新と新規作成などを行う関数。新規登録自体は、対象とするテーブルの指定ができれば単純にレコードを記述するだけ。更新に関してはConcatenate(テキストの追加)等でテキストの指定をしつつ行うことになる。

```
Patch(DataSource,
    Defaults(DataSource),
    {
        ID: thisItem.ID,
        Name: thisItem.Name
    }
)
```

### Defaults

`Defaults(データソース)` データソースの規定の状態を取得する関数。使用方法もまんま。